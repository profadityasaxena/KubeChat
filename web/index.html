<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KubeChat – RAG Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem auto; max-width: 900px; padding: 0 1rem; }
    h1 { margin: 0 0 0.5rem; }
    .row { display: grid; gap: .75rem; grid-template-columns: 1fr 1fr; }
    .col { display: flex; flex-direction: column; gap: .5rem; }
    label { font-size: .9rem; color: #444; }
    textarea, input, select { width: 100%; box-sizing: border-box; padding: .6rem .7rem; border: 1px solid #ccc; border-radius: .5rem; font-size: 1rem; }
    button { padding: .65rem 1rem; border: 0; border-radius: .5rem; background: #0ea5e9; color: white; font-weight: 600; cursor: pointer; }
    button:disabled { opacity: .6; cursor: default; }
    .status { font-size: .9rem; color: #555; margin-top: .5rem; min-height: 1.2em; }
    .card { background: #fafafa; border: 1px solid #eee; border-radius: .75rem; padding: 1rem; }
    .sources li { margin: .25rem 0; }
    code { background: #f3f3f3; padding: .1rem .3rem; border-radius: .3rem; }
  </style>
</head>
<body>
  <h1>KubeChat</h1>
  <p class="status" id="health">Checking API…</p>

  <div class="row">
    <div class="col">
      <label for="q">Question</label>
      <textarea id="q" rows="5" placeholder="Ask something about your PDFs…"></textarea>
    </div>
    <div class="col">
      <label for="pathExact">Filter by filename (optional)</label>
      <input id="pathExact" placeholder="e.g., 11.pdf (exact match)" />

      <label class="small" for="pathContains">Or substring filter (optional)</label>
      <input id="pathContains" placeholder='e.g., "Kubernetes Direction" (substring)' />

      <div class="row">
        <div class="col">
          <label for="topK">Top K</label>
          <select id="topK">
            <option>4</option><option selected>6</option><option>8</option><option>10</option>
          </select>
        </div>
        <div class="col">
          <label for="numPredict">Max tokens</label>
          <select id="numPredict">
            <option>80</option><option selected>160</option><option>256</option><option>512</option>
          </select>
        </div>
      </div>
      <button id="askBtn">Ask</button>
      <div class="status" id="status"></div>
    </div>
  </div>

  <h3>Answer</h3>
  <div class="card">
    <pre id="answer" style="white-space: pre-wrap; margin: 0;"></pre>
  </div>

  <h3>Sources</h3>
  <ul id="sources" class="sources"></ul>

  <script>
    const API = "http://localhost:8000";
    const els = {
      health:  document.getElementById("health"),
      q:       document.getElementById("q"),
      pathEx:  document.getElementById("pathExact"),
      pathSub: document.getElementById("pathContains"),
      topK:    document.getElementById("topK"),
      numPred: document.getElementById("numPredict"),
      ask:     document.getElementById("askBtn"),
      status:  document.getElementById("status"),
      answer:  document.getElementById("answer"),
      sources: document.getElementById("sources"),
    };

    async function checkHealth() {
      try {
        const r = await fetch(API + "/health");
        if (!r.ok) throw new Error();
        const j = await r.json();
        els.health.textContent = "API: " + (j.status || "ok");
      } catch {
        els.health.textContent = "API not reachable at " + API + " — keep the stack running.";
      }
    }

    function setBusy(b, msg="") {
      els.ask.disabled = b;
      els.status.textContent = msg;
    }

    function renderAnswer(text, sources) {
      els.answer.textContent = text || "";
      els.sources.innerHTML = "";
      (sources || []).forEach(s => {
        const li = document.createElement("li");
        li.textContent = `${s.path || "(unknown)"}  •  chunk ${s.chunk_id}  •  score ${Number(s.score).toFixed(3)}`;
        els.sources.appendChild(li);
      });
    }

    async function ask() {
      const body = {
        question:    els.q.value.trim(),
        top_k:       parseInt(els.topK.value, 10),
        num_predict: parseInt(els.numPred.value, 10),
        num_gpu:     32
      };
      const ex = els.pathEx.value.trim();
      const sub = els.pathSub.value.trim();
      if (ex) body.path_exact = ex;
      else if (sub) body.path_contains = sub;

      if (!body.question) { els.status.textContent = "Type a question first."; return; }

      setBusy(true, "Waiting…");
      renderAnswer("", []);
      try {
        const r = await fetch(API + "/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const j = await r.json();
        renderAnswer(j.answer, j.sources);
        setBusy(false, "");
      } catch (e) {
        setBusy(false, "Request failed. Check that rag-api is running.");
      }
    }

    els.ask.addEventListener("click", ask);
    checkHealth();
  </script>
</body>
</html>
